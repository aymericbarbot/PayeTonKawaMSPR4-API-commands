# .github/workflows/ci-ci-test.yml
name: ci-dev

on:
  push:
    branches: [ ci-test ]      # déclenché après merge d’une PR

permissions:
  contents: write
  id-token: write              # pour d'éventuels besoins futurs

jobs:
  # ─────────────────────────────────────
  unit:
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.ok.outputs.state }}

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: npm
    - id: tests
      run: |
        npm ci
        npm run build
        npm test
      continue-on-error: true
    - id: ok
      run: echo "state=${{ steps.tests.outcome }}" >> "$GITHUB_OUTPUT"

  # ─────────────────────────────────────
  compose:
    needs: unit
    if: needs.unit.outputs.ok == 'success'
    runs-on: ubuntu-latest
    services:
      rabbitmq:
        image: rabbitmq:3.13-management
        ports: ['5672:5672']
    outputs:
      ok: ${{ steps.comp_ok.outputs.state }}

    steps:
    - uses: actions/checkout@v4
    - id: compose
      run: |
        docker compose -f docker-compose.yml \
                       up --abort-on-container-exit --exit-code-from client-service
      continue-on-error: true
    - id: comp_ok
      run: echo "state=${{ steps.compose.outcome }}" >> "$GITHUB_OUTPUT"

  # ─────────────────────────────────────
  handle-failure:
    needs: [unit, compose]
    if: >
      needs.unit.outputs.ok != 'success' ||
      needs.compose.outputs.ok != 'success'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with: { fetch-depth: 2 }

    - name: Git config bot
      run: |
        git config user.email "bot@github"
        git config user.name  "github-actions"

    - name: Create error branch & rollback
      run: |
        ERR="error-${GITHUB_SHA::8}"
        git switch -c "$ERR"
        git push origin "$ERR"
        git switch ci-test
        git reset --hard HEAD~1
        git push --force-with-lease origin ci-test

    - name: Notify pusher by email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.SMTP_SERVER }}
        server_port:     ${{ secrets.SMTP_PORT }}
        username:        ${{ secrets.SMTP_USER }}
        password:        ${{ secrets.SMTP_PASS }}
        subject: "[CI] Échec des tests après merge dans ci-test"
        to: ${{ github.event.pusher.email }}
        from: ${{ secrets.SMTP_FROM }}
        body: |
          Les tests (unitaires ou intégration) ont échoué pour le commit
          ${{ github.sha }} que tu viens de fusionner dans ci-test.
          La branche ci-test a été restaurée et le commit stocké dans ${{ env.ERR }}.
